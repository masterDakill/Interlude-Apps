<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Firebase - Diagnostic Simple</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 2rem auto;
      padding: 0 1rem;
      background: #f3f4f6;
    }
    .container {
      background: white;
      border-radius: 1rem;
      padding: 2rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    h1 {
      color: #1f2937;
      margin: 0 0 0.5rem 0;
    }
    .subtitle {
      color: #6b7280;
      margin: 0 0 2rem 0;
    }
    .status {
      padding: 1rem;
      border-radius: 0.5rem;
      margin: 1rem 0;
      font-weight: 500;
    }
    .success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #6ee7b7;
    }
    .error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
    }
    .info {
      background: #dbeafe;
      color: #1e40af;
      border: 1px solid #93c5fd;
    }
    .warning {
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #fcd34d;
    }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      margin: 0.5rem 0.5rem 0.5rem 0;
    }
    button:hover {
      background: #2563eb;
    }
    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    pre {
      background: #1f2937;
      color: #f3f4f6;
      padding: 1rem;
      border-radius: 0.5rem;
      overflow-x: auto;
      font-size: 0.875rem;
    }
    .step {
      margin: 1.5rem 0;
      padding: 1rem;
      background: #f9fafb;
      border-left: 4px solid #3b82f6;
      border-radius: 0.25rem;
    }
    .step-title {
      font-weight: 600;
      color: #1f2937;
      margin: 0 0 0.5rem 0;
    }
    .step-desc {
      color: #6b7280;
      margin: 0;
      font-size: 0.875rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üî• Test Firebase - Diagnostic</h1>
    <p class="subtitle">V√©rification de la connexion et des permissions Firestore</p>

    <div id="status"></div>
    <div id="logs"></div>

    <div class="step">
      <p class="step-title">√âtape 1: Tester la connexion</p>
      <p class="step-desc">V√©rifie si Firebase est correctement initialis√©</p>
      <button onclick="testConnection()">1Ô∏è‚É£ Tester Connexion</button>
    </div>

    <div class="step">
      <p class="step-title">√âtape 2: Tester l'√©criture</p>
      <p class="step-desc">Essaie d'√©crire une chanson test dans Firestore</p>
      <button onclick="testWrite()" id="btnWrite" disabled>2Ô∏è‚É£ √âcrire Chanson Test</button>
    </div>

    <div class="step">
      <p class="step-title">√âtape 3: Lire les donn√©es</p>
      <p class="step-desc">R√©cup√®re toutes les chansons de Firestore</p>
      <button onclick="testRead()" id="btnRead" disabled>3Ô∏è‚É£ Lire Chansons</button>
    </div>

    <div id="instructions" style="display: none;" class="warning">
      <strong>‚ö†Ô∏è Firestore n'est pas activ√©!</strong>
      <ol style="margin: 1rem 0 0 1rem; padding: 0;">
        <li>Allez sur <a href="https://console.firebase.google.com/project/interludeapp-2ff3f/firestore" target="_blank" style="color: #2563eb;">Firebase Console</a></li>
        <li>Cliquez sur "Cr√©er une base de donn√©es"</li>
        <li>Choisissez "Mode test" (permet lecture/√©criture pendant 30 jours)</li>
        <li>S√©lectionnez une r√©gion (ex: us-east1)</li>
        <li>Cliquez "Activer"</li>
        <li>Revenez ici et cliquez "1Ô∏è‚É£ Tester Connexion"</li>
      </ol>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getFirestore, collection, addDoc, getDocs, Timestamp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDZqi57_XK-LNXFVNotiqXKYRUkNh-gHCo",
      authDomain: "interludeapp-2ff3f.firebaseapp.com",
      projectId: "interludeapp-2ff3f",
      storageBucket: "interludeapp-2ff3f.firebasestorage.app",
      messagingSenderId: "1068934787939",
      appId: "1:1068934787939:web:773c0131cba6c665671956"
    };

    let app, db;

    function log(message, type = 'info') {
      const logsDiv = document.getElementById('logs');
      const logEntry = document.createElement('div');
      logEntry.className = `status ${type}`;
      logEntry.innerHTML = message;
      logsDiv.appendChild(logEntry);
      logsDiv.scrollTop = logsDiv.scrollHeight;
    }

    window.testConnection = async function() {
      const statusDiv = document.getElementById('status');
      const btnWrite = document.getElementById('btnWrite');
      const btnRead = document.getElementById('btnRead');
      const instructions = document.getElementById('instructions');
      
      try {
        log('üîÑ Initialisation de Firebase...', 'info');
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        
        log('‚úÖ Firebase initialis√© avec succ√®s!', 'success');
        log(`üì¶ Projet: ${firebaseConfig.projectId}`, 'info');
        
        // Tester si Firestore est activ√©
        log('üîç V√©rification de Firestore...', 'info');
        try {
          const testCollection = collection(db, 'songs');
          const snapshot = await getDocs(testCollection);
          
          log(`‚úÖ Firestore est activ√©! (${snapshot.size} chansons trouv√©es)`, 'success');
          btnWrite.disabled = false;
          btnRead.disabled = false;
          instructions.style.display = 'none';
          
        } catch (firestoreError) {
          if (firestoreError.code === 'permission-denied') {
            log('‚ùå ERREUR: Permissions refus√©es', 'error');
            log('üí° Les r√®gles Firestore bloquent l\'acc√®s. V√©rifiez les r√®gles dans la console Firebase.', 'warning');
            instructions.style.display = 'block';
          } else {
            log(`‚ùå ERREUR Firestore: ${firestoreError.message}`, 'error');
            log('üí° Firestore n\'est peut-√™tre pas activ√©. Suivez les instructions ci-dessous:', 'warning');
            instructions.style.display = 'block';
          }
        }
        
      } catch (error) {
        log(`‚ùå ERREUR d'initialisation: ${error.message}`, 'error');
        log(`Code: ${error.code}`, 'error');
        console.error(error);
      }
    };

    window.testWrite = async function() {
      if (!db) {
        log('‚ùå Firebase pas initialis√©. Lancez d\'abord le test de connexion.', 'error');
        return;
      }
      
      try {
        log('üìù √âcriture d\'une chanson test...', 'info');
        
        const testSong = {
          title: 'Test Firebase - ' + new Date().toLocaleTimeString(),
          artist: 'Test Automatique',
          duration: '3:00',
          genre: 'Test',
          tempo: 120,
          key: 'C',
          createdAt: Timestamp.now()
        };
        
        const docRef = await addDoc(collection(db, 'songs'), testSong);
        
        log(`‚úÖ Chanson √©crite avec succ√®s!`, 'success');
        log(`üìÑ ID du document: ${docRef.id}`, 'success');
        log(`<pre>${JSON.stringify(testSong, null, 2)}</pre>`, 'success');
        
        document.getElementById('btnRead').disabled = false;
        
      } catch (error) {
        log(`‚ùå ERREUR d'√©criture: ${error.message}`, 'error');
        log(`Code: ${error.code}`, 'error');
        console.error(error);
        
        if (error.code === 'permission-denied') {
          log('üí° Solution: V√©rifiez les r√®gles Firestore dans la console Firebase', 'warning');
        }
      }
    };

    window.testRead = async function() {
      if (!db) {
        log('‚ùå Firebase pas initialis√©. Lancez d\'abord le test de connexion.', 'error');
        return;
      }
      
      try {
        log('üìñ Lecture des chansons...', 'info');
        
        const snapshot = await getDocs(collection(db, 'songs'));
        
        log(`‚úÖ ${snapshot.size} chanson(s) trouv√©e(s)`, 'success');
        
        if (snapshot.size === 0) {
          log('‚ÑπÔ∏è Aucune chanson dans la base. Utilisez "√âcrire Chanson Test" pour en ajouter une.', 'info');
        } else {
          snapshot.forEach(doc => {
            const data = doc.data();
            log(`<strong>üéµ ${data.title}</strong> - ${data.artist}`, 'success');
            log(`<pre>${JSON.stringify(data, null, 2)}</pre>`, 'success');
          });
        }
        
      } catch (error) {
        log(`‚ùå ERREUR de lecture: ${error.message}`, 'error');
        log(`Code: ${error.code}`, 'error');
        console.error(error);
      }
    };

    // Log initial
    log('üëã Pr√™t √† tester! Cliquez sur "1Ô∏è‚É£ Tester Connexion" pour commencer.', 'info');
  </script>
</body>
</html>
